<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laporan Harian • BigMotor</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>

    .total-row {
  margin-top: 10px;
  padding-top: 12px;
  border-top: 2px solid #dfe3eb;
}
body {
  background: linear-gradient(#f4f6fa, #eef1f6);
}
    /* FAB BACK LEFT BOTTOM */
.fab-back{
  position:fixed;
  left:18px;
  bottom:18px;
  width:58px;
  height:58px;
  border-radius:50%;
  background:rgba(255,255,255,0.3);   /* transparan */
  box-shadow:0 4px 18px rgba(0,0,0,0.22);
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  z-index:999;
  backdrop-filter: blur(4px);         /* opsional: modern look */
}
.fab-back img{
  width:32px;
  height:32px;
  object-fit:contain;
}
:root{
  --bg:#f4f5f7;
  --card:#fff;
  --primary:#1560ff;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 8px 20px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
body{margin:0;background:var(--bg);padding-bottom:120px}

/* ========== GLOBAL FIX ========== */
*{
  -webkit-tap-highlight-color: transparent;
}

/* ========== HEADER (COPY 1:1 DARI PENGATURAN) ========== */
.sticky-top{
  position:sticky;
  top:0;
  z-index:50;
  background:var(--bg);
  padding:12px;
}

.header-wrap{
  border-radius:18px;
  overflow:hidden;
  background:#fff;
  box-shadow:0 10px 28px rgba(0,0,0,.12);
}

.header{
  background:linear-gradient(
    90deg,
    #d3e2ff 0%,
    #e8f0ff 50%,
    #f5f8ff 100%
  );
  padding:14px 16px;
  padding-right:90px;
  position:relative;
  border-bottom:1px solid #e6eefc;
}

.header::before{
  content:"";
  position:absolute;
  inset:0;
  background:url("assets/headerbg.png") center/cover no-repeat;
  opacity:.20;
  z-index:1;
  pointer-events:none;
}

.header > *{ position:relative; z-index:2; }

.h-title{
  font-size:18px;
  font-weight:800;
}

.h-sub{
  font-size:14px;
  font-weight:600;
  color:#666;
  margin-top:2px;
}

.h-time{
  font-size:13px;
  color:#666;
  margin-top:6px;
}

.header-icon{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  width:80px;
  height:auto;
  z-index:5;
}

.container{max-width:980px;margin:12px auto;padding:0 12px}

.card {
  border-radius: 14px;
  padding: 18px;
  background: white;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  border: 1px solid #eef0f3;
}
.card-title {
  font-size: 16px;
  font-weight: 800;
  margin-bottom: 12px;
  color: #1a1f36;
}
.row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  font-size: 14px;
  border-bottom: 1px solid #f1f2f4;
}
.row:last-of-type {
  border-bottom: 0;
}
.row-strong {
  font-weight: 900;
  color: #0f3ddd;
}
.row:first-of-type{border-top:0}
.userBox{display:flex;align-items:center;gap:10px;margin-top:8px}
.userBox img{width:36px;height:36px;border-radius:50%;object-fit:cover}
.fab{position:fixed;
  right:18px;
bottom:18px;
width:58px;
height:58px;border-radius:999px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:34px;box-shadow:0 10px 24px rgba(0,0,0,0.18);cursor:pointer;z-index:60}
.popup-bg{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:70}
.popup{width:92%;max-width:420px;background:#fff;border-radius:12px;padding:16px}
.popup-title{font-weight:800;margin-bottom:12px}
.field{margin-bottom:10px}
label{display:block;font-size:13px;color:#333;margin-bottom:6px;font-weight:600}
.inp{width:100%;padding:10px;border-radius:10px;border:1px solid #e2e8f0;font-size:14px}
.inp[disabled]{background:#f3f4f6;color:#374151;font-weight:700}
.row-strong{font-weight:800}
.btn{width:100%;padding:11px;border-radius:10px;border:0;background:var(--primary);color:#fff;font-weight:800;margin-top:8px}
.btn-ghost{background:#6b7280}
.note{font-size:12px;color:#6b7280;margin-top:8px}
.loading{padding:22px;text-align:center;color:var(--muted)}

.card-bg-mid {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 160px;              /* sesuaikan */
  transform: translate(-50%, -50%);
  opacity: 0.35;             /* lebih kuat dari invoice */
  filter: contrast(1.3) brightness(1.05);
  pointer-events: none;
  user-select: none;
  z-index: 1;
}
.card { position: relative; overflow: hidden; }
</style>
</head>
<body>
<div class="sticky-top">
  <div class="header-wrap">
    <div class="header">
      <div class="h-title">Laporan Harian</div>
      <div class="h-sub">BIG Motor</div>
      <div id="headerTime" class="h-time"></div>
      <img src="assets/lapor.png" class="header-icon">
    </div>
  </div>
</div>

<div class="container" id="listRoot">
  <div class="loading">Memuat...</div>
</div>

<div class="fab" title="Tambah" onclick="openPopup()">+</div>

<!-- POPUP -->
<div id="popupBg" class="popup-bg" onclick="if(event.target===this) closePopup()">
  <div class="popup" role="dialog" aria-modal="true">
    <div class="popup-title">Tambah Laporan Harian</div>

    <div class="field">
      <label for="penjualanTotal">Penjualan Total (dari penjualan)</label>
      <input id="penjualanTotal" class="inp" disabled />
    </div>

    <div class="field">
      <label for="penjualanCash">Penjualan Cash (otomatis)</label>
      <input id="penjualanCash" class="inp" disabled />
    </div>

    <div class="field">
      <label for="penjualanTransfer">Penjualan QR / Transfer (input)</label>
      <input id="penjualanTransfer" class="inp" placeholder="Rp 0" />
    </div>

    <div class="field">
      <label for="pengeluaran">Pengeluaran Hari Ini (dari pengeluaran)</label>
      <input id="pengeluaran" class="inp" disabled />
    </div>

    <div class="field">
      <label for="uangAngin">Uang Angin (input)</label>
      <input id="uangAngin" class="inp" placeholder="Rp 0" />
    </div>

    <div class="field">
      <label for="chargeServis">Charge Servis (input)</label>
      <input id="chargeServis" class="inp" placeholder="Rp 0" />
    </div>

    <div class="note">Pastikan nominal sudah sesuai sebelum menyimpan.</div>

    <button class="btn" onclick="save()">Simpan</button>
    <button class="btn btn-ghost" style="margin-top:8px" onclick="closePopup()">Batal</button>
  </div>
</div>

<script>
const API = "https://api.bigmotor.biz.id";
const API_NEW = "https://msg.wendyrenzya.workers.dev";
// API baru untuk meniru cara laporan.html mengambil penjualan harian
const API_LAPORAN = "https://api.bigmotor.biz.id";

const $ = id => document.getElementById(id);

/* time */
function updateHeaderTime(){
  const d = new Date();
  document.getElementById("headerTime").textContent =
    d.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})
    + " • " +
    d.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"});
}
updateHeaderTime();
setInterval(updateHeaderTime, 10000);
/* helpers */
function toNum(s){ return Number(String(s).replace(/[^0-9]/g,"")) || 0; }
function fmt(n){ return "Rp " + Number(n||0).toLocaleString("id-ID"); }
function setVal(el, num){ el.value = fmt(num); el.dataset.val = String(Number(num||0)); }
function setRaw(el, num){ el.value = String(num); el.dataset.val = String(Number(num||0)); }

/* compute tomorrow for range endpoints */
function todayStr(){
  return new Date().toISOString().slice(0,10);
}
function tomorrowStr(){
  const d=new Date(); d.setDate(d.getDate()+1); return d.toISOString().slice(0,10);
}

function formatTanggal(t){
  // input: "2025-11-30"
  const d = new Date(t + "T00:00:00");
  if (isNaN(d)) return t;

  const hariID = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
  const bulanID = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"];

  const hari = hariID[d.getDay()];
  const tanggal = String(d.getDate()).padStart(2,"0");
  const bulan = bulanID[d.getMonth()];
  const tahun = d.getFullYear();

  return `${hari}, ${tanggal} ${bulan} ${tahun}`;
}


/* LOAD LIST (cards) */
async function loadList(){
  const root = $("listRoot");
  root.innerHTML = '<div class="loading">Memuat...</div>';

  try{
    const r = await fetch(`https://msg.wendyrenzya.workers.dev/api/laporan_harian/list`);
    const j = await r.json();

    root.innerHTML = "";

    if(!j.items || j.items.length === 0){
      root.innerHTML = '<div class="loading">Belum ada laporan</div>';
      return;
    }

    j.items.forEach(d => {
  const card = document.createElement("div");
  card.className = "card";

  // Buat background
  const bg = document.createElement("img");
  bg.src = "assets/harian200.png";
  bg.className = "card-bg-mid";

  // Isi card
  card.innerHTML = `
    <div class="card-title">${formatTanggal(d.tanggal)}</div>

    <div class="row"><div>Penjualan Total</div>
      <div class="row-strong">${fmt(Number(d.penjualan_cash) + Number(d.penjualan_transfer))}</div>
    </div>

    <div class="row"><div>Cash</div>
      <div>${fmt(d.penjualan_cash)}</div>
    </div>

    <div class="row"><div>Transfer</div>
      <div>${fmt(d.penjualan_transfer)}</div>
    </div>

    <div class="row"><div>Pengeluaran</div>
      <div>${fmt(d.pengeluaran)}</div>
    </div>

    <div class="row"><div>Uang Angin</div>
      <div>${fmt(d.uang_angin)}</div>
    </div>

    <div class="row"><div>Charge Servis</div>
      <div>${fmt(d.charge_servis)}</div>
    </div>

    <div class="row total-row">
      <div>Total Setoran</div>
      <div class="row-strong">${
        fmt(
          Number(d.penjualan_cash)
          + Number(d.uang_angin)
          + Number(d.charge_servis)
          - Number(d.pengeluaran)
        )
      }</div>
    </div>
  `;

  // Penting: append gambar SETELAH innerHTML
  card.appendChild(bg);

  root.appendChild(card);
});

  }catch(err){
    root.innerHTML = '<div class="loading">Gagal memuat data</div>';
    console.error(err);
  }
}

/* POPUP logic */
function openPopup(){
  $("popupBg").style.display = "flex";
  loadFormData();
}
function closePopup(){
  $("popupBg").style.display = "none";
}

/* attach formatting listeners to inputs that accept numbers */
function attachMoneyInput(id){
  const el = $(id);
  let composing = false;
  el.addEventListener("compositionstart",()=>composing=true);
  el.addEventListener("compositionend", (e)=>{ composing=false; onMoneyInput(e); });
  el.addEventListener("input", (e)=>{ if(!composing) onMoneyInput(e); });
  function onMoneyInput(e){
    const target = e.target;
    const n = toNum(target.value);
    target.value = fmt(n);
    target.dataset.val = String(n);
    recalcCash();
  }
}

/* setup inputs */
attachMoneyInput("penjualanTransfer");
attachMoneyInput("uangAngin");
attachMoneyInput("chargeServis");

async function loadFormData(){
  // reset field input manual
  setVal($("penjualanTransfer"), 0);
  setVal($("uangAngin"), 0);
  setVal($("chargeServis"), 0);

  try{
    const today    = todayStr();
    const tomorrow = tomorrowStr();

    // AMBIL DATA PENJUALAN HARIAN → MENGIKUTI laporan.html
    const r = await fetch(`${API_LAPORAN}/api/laporan/harian?start=${today}&end=${tomorrow}`);
    const j = await r.json();

    const arr = j.items || [];
    const row = arr[0] || {};

    const totalPenjualan = Number(row.penjualan || 0);

// ambil hanya 2 kategori (operasional + lain-lain)
const pengeluaran = Number(row.pengeluaran_operasional_lain || 0);

    // TAMPILKAN LANGSUNG DI INPUTBOX
    setVal($("penjualanTotal"), totalPenjualan);
    setVal($("penjualanCash"), totalPenjualan); // cash awal mengikuti total
    setVal($("pengeluaran"), pengeluaran);

    // Transfer default 0, nanti bisa diubah user
    $("penjualanTransfer").dataset.val = "0";

    recalcCash();
  }
  catch(err){
    console.error(err);
  }
}

/* recalc penjualan cash when transfer changed */
function recalcCash(){
  const total = Number($("penjualanTotal").dataset.val || 0);
  const transfer = Number($("penjualanTransfer").dataset.val || 0);
  const cash = total - transfer;
  setVal($("penjualanCash"), cash);
}

/* SAVE */
async function save(){
  const start = todayStr();
  const end   = tomorrowStr();

  const tanggal = start;
  const penjualan_cash = Number($("penjualanCash").dataset.val || 0);
  const penjualan_transfer = Number($("penjualanTransfer").dataset.val || 0);
  const pengeluaran = Number($("pengeluaran").dataset.val || 0); // pengeluaran from penjualan endpoint
  const uang_angin = Number($("uangAngin").dataset.val || 0);
  const charge_servis = Number($("chargeServis").dataset.val || 0);

  // validate presence of required fields (transfer can be 0, angin and servis can be 0)
  // make sure penjualan_total is present (>=0)
  const penjualan_total = Number($("penjualanTotal").dataset.val || 0);

  if(penjualan_total < 0) { alert("Penjualan total tidak valid"); return; }

  // post to worker: worker.save expects tanggal, penjualan_cash, penjualan_transfer, pengeluaran, uang_angin, charge_servis
  try{
    const now = new Date().toISOString();

const res = await fetch(`${API_NEW}/api/laporan/harian`,{
  method: "POST",
  headers: {"Content-Type":"application/json"},
  body: JSON.stringify({
    tanggal,
    penjualan_cash,
    penjualan_transfer,
    pengeluaran,
    uang_angin,
    charge_servis,
    created_at: now
  })
});
  const j = await res.json();
console.log("RESPON SERVER:", j);
alert("Berhasil disimpan");

if(!res.ok){
  console.error(j);
  alert("Gagal menyimpan laporan");
  return;
}
  }catch(err){
    console.error(err);
    alert("Gagal menyimpan laporan (network)");
    return;
  }

  closePopup();
  await loadList();
}

/* init */
loadList();
</script>
<div class="fab-back" id="fabBack">
  <img src="assets/back_white.png">
</div>

<script>
  document.getElementById("fabBack").onclick = () => history.back();
</script>
</body>
</html>
