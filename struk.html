<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Struk</title>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
body{
  margin:0;
  font-family: Inter, Arial, sans-serif;
  background:#f3f3f3;
  padding:20px;
}

/* WRAPPER STRUK */
#wrap{
  background:#fff;
  padding:20px;
  border-radius:10px;
  max-width:420px;
  margin:60px auto 0 auto;
  box-shadow:0 3px 10px rgba(0,0,0,.15);
}
.center{text-align:center}
.line{border-bottom:1px dashed #000;margin:10px 0}
.title{font-weight:700;font-size:18px;margin-top:10px;text-align:center}
.item-row{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px dashed #ddd;
  font-size:14px;
}
.label{font-weight:700}

/* TOP BUTTONS AREA */
#topBar{
  position:fixed;
  top:10px; left:0; right:0;
  display:flex;
  flex-direction:row;
  justify-content:flex-end;
  align-items:center;
  gap:10px;
  padding:0 12px;
  z-index:9999;
}

/* TOMBOL TUTORIAL SEJAJAR X */
#btnTutorialTop{
  background:#ff8c42;
  color:#fff;
  font-weight:700;
  font-size:13px;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
  box-shadow:0 3px 6px rgba(0,0,0,0.18);
  white-space:nowrap;
  transition:transform .12s;
}
#btnTutorialTop:active{ transform:scale(0.92); }

/* CLOSE BUTTON */
#closeBtn{
  background:#ff3b30;
  color:#fff;
  border:0;
  border-radius:50%;
  width:38px;height:38px;
  font-size:20px;
  font-weight:900;
  cursor:pointer;
}

.actionBar{
  margin-top:20px;
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  gap:12px;
}

.actionBtn{
  flex:1 1 calc(25% - 12px);
  border-radius:12px;
  padding:12px 0 6px 0;
  text-align:center;
  cursor:pointer;
  color:#fff;
  box-shadow:0 3px 6px rgba(0,0,0,0.15);
  transition:transform .12s;
}

.actionBtn:active{ transform:scale(0.88); }

.actionBtn svg{
  width:26px;height:26px;opacity:0.95;
}
.actionLabel{
  display:block;
  margin-top:5px;
  font-size:12px;
}

/* WARNA */
#btnSharePng{ background:#2ecc71; }
#btnCopyTxt{ background:#9b59b6; }
#btnDownloadTxt{ background:#3498db; }
#btnPrintTxt{ background:#f1c40f; color:#000; }
</style>
</head>

<body>

<!-- TOPBAR (TUTORIAL + X) -->
<div id="topBar">
  <div id="btnTutorialTop">Lihat Tutorial Print</div>
  <button id="closeBtn">×</button>
</div>

<div id="wrap">

  <div class="center">
    <img src="assets/logo2.png" style="width:120px;margin-bottom:10px">
  </div>

  <div id="header"></div>
  <div class="line"></div>

  <div id="srvExtra" style="display:none"></div>
  <div class="line"></div>

  <div id="items"></div>
  <div class="line"></div>

  <div id="totals"></div>
  <div class="line"></div>

  <div id="operator"></div>

  <br>
  <div class="center" style="font-size:13px;margin-top:10px;">
    <b>BIG Motor Tingkulu</b><br>
    Jl. Tololiu Supit, Wanea 95117<br>
    bigmotortingkulu.com
  </div>
</div>

<!-- BUTTON BAR -->
<div class="actionBar">

  <div class="actionBtn" id="btnSharePng">
    <svg viewBox="0 0 24 24">
      <path d="M4 12c0-1.1.9-2 2-2h7V7l5 5-5 5v-3H6c-1.1 0-2-.9-2-2z"/>
    </svg>
    <span class="actionLabel">Share</span>
  </div>

  <div class="actionBtn" id="btnCopyTxt">
    <svg viewBox="0 0 24 24">
      <path d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2z"/>
    </svg>
    <span class="actionLabel">Copy</span>
  </div>

  <div class="actionBtn" id="btnDownloadTxt">
    <svg viewBox="0 0 24 24">
      <path d="M5 20h14v2H5v-2zM12 3v11l4-4h-3V3h-2v7H8l4 4V3z"/>
    </svg>
    <span class="actionLabel">Download</span>
  </div>

  <div class="actionBtn" id="btnPrintTxt">
    <svg viewBox="0 0 24 24">
      <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM7 19v-4h10v4H7zm12-7H5c-.55 0-1-.45-1-1s.45-1 1-1h14c.55 0 1 .45 1 1s-.45 1-1 1zM17 1H7v4h10V1z"/>
    </svg>
    <span class="actionLabel">Print</span>
  </div>

</div>

<script>
const API_BASE="https://api.bigmotor.biz.id";
const tid=new URLSearchParams(location.search).get("tid");

function currency(n){return "Rp " + Number(n||0).toLocaleString("id-ID");}
function iso(s){
  const d=new Date(s);
  if(!s) return "-";
  return d.toLocaleString("id-ID",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"});
}

let STRUK_TXT="", RAW_TXT="";

function buildTxt(){
  STRUK_TXT =
    document.getElementById("header").innerText + "\n" +
    "----------------------------\n" +
    (document.getElementById("srvExtra").innerText.trim()
      ? document.getElementById("srvExtra").innerText + "\n----------------------------\n"
      : "") +
    document.getElementById("items").innerText + "\n----------------------------\n" +
    document.getElementById("totals").innerText + "\n----------------------------\n" +
    document.getElementById("operator").innerText + "\n";
}
function buildRaw(isServis,waktu,user,main,barangList,charges,totalBarang,totalServis,totalCharge){
  let t="";
  t+=`Jenis: ${isServis?"Servis":"Penjualan"}\n`;
  t+=`ID: ${tid}\n`;
  t+=`Waktu: ${iso(waktu)}\n`;
  t+=`Operator: ${user}\n\n`;

  t+=`Barang:\n`;
  for(let i=0;i<barangList.length;i++){
    const b=barangList[i];
    t+=`${i+1}. Nama: ${b.nama}\n`;
    t+=`   Qty: ${b.qty}\n`;
    t+=`   Harga: ${b.harga}\n`;
    t+=`   Total: ${b.qty*b.harga}\n`;
  }

  if(isServis && charges.length){
    t+=`\nCharge:\n`;
    for(const c of charges){
      t+=`- Nama: ${c.nama_servis}\n  Biaya: ${c.biaya_servis}\n`;
    }
  }

  t+=`\nTotal barang: ${totalBarang}\n`;
  if(isServis){
    t+=`Total charge: ${totalCharge}\n`;
    t+=`Total servis: ${totalServis}\n`;
    t+=`Grand total: ${totalBarang+totalServis+totalCharge}\n`;
  } else {
    t+=`Grand total: ${totalBarang}\n`;
  }

  RAW_TXT = t;
}

/* LOAD STRUK */
async function loadStruk(){
  const r=await fetch(`${API_BASE}/api/riwayat/${tid}`);
  const j=await r.json();

  const header=document.getElementById("header");
  const items=document.getElementById("items");
  const totals=document.getElementById("totals");
  const srvExtra=document.getElementById("srvExtra");
  const operator=document.getElementById("operator");

  const isServis = tid.startsWith("SRV-");

  let waktu="", user="-", barangList=[], charges=[];
  let totalBarang=0, totalServis=0, totalCharge=0;

  if(isServis){
    const svc=(await (await fetch(`${API_BASE}/api/servis`)).json()).items || [];
    const core=tid.replace(/^SRV-|^CHG-/,"");
    const main=svc.find(x=>x.transaksi_id?.startsWith("SRV-") &&
                           x.transaksi_id.replace(/^SRV-|^CHG-/,"")==core) || {};

    waktu = main.created_at || main.updated_at;
    user = main.dibuat_oleh || main.diselesaikan_oleh || "-";

    let list=[];
    try{ list=JSON.parse(main.items||"[]"); }catch{}

    for(const b of list){
      let nm="";
      try { nm = await getNamaBarang(b.id||b.id_barang||b.barang_id); }
      catch { nm = "Barang #" + (b.id||b.id_barang||b.barang_id); }

      const qty=b.qty||b.jumlah||0;
      const harga=Number(b.harga||0);

      barangList.push({nama:nm,qty:qty,harga:harga});
      totalBarang += qty*harga;

      items.innerHTML+=`
        <div class="item-row">
          <div><div class="label">${nm}</div>${qty} pcs × ${currency(harga)}</div>
          <div>${currency(qty*harga)}</div>
        </div>`;
    }

    charges = svc.filter(c=>c.transaksi_id?.startsWith("CHG-") &&
                             c.transaksi_id.replace(/^SRV-|^CHG-/,"")==core);
    charges.forEach(c=>totalCharge+=Number(c.biaya_servis||0));

    totalServis=Number(main.biaya_servis||0);

    totals.innerHTML=`
      Total Barang: ${currency(totalBarang)}<br>
      Biaya Servis: ${currency(totalServis)}<br>
      Charge: ${currency(totalCharge)}<br><br>
      <b>Grand Total: ${currency(totalBarang+totalServis+totalCharge)}</b>
    `;
buildRaw(true, waktu, user, main, barangList, charges, totalBarang, totalServis, totalCharge);
    srvExtra.style.display="block";
    srvExtra.innerText=`Nama: ${main.nama_servis}\nTeknisi: ${main.teknisi}`;
  }

  else {
    const keluar=j.keluar||[];
    user=keluar[0]?.dibuat_oleh||"-";
    waktu=keluar[0]?.created_at||"";

    for(const r3 of keluar){
      let nm="";
      try { nm = await getNamaBarang(r3.barang_id); }
      catch { nm = "Barang #" + r3.barang_id; }

      const qty=r3.jumlah||0;
      const harga=Number(r3.harga||0);

      barangList.push({nama:nm,qty:qty,harga:harga});
      totalBarang += qty*harga;

      items.innerHTML+=`
        <div class="item-row">
          <div><div class="label">${nm}</div>${qty} pcs × ${currency(harga)}</div>
          <div>${currency(qty*harga)}</div>
        </div>`;
    }

    totals.innerHTML=`
      Total Barang: ${currency(totalBarang)}<br>
      <b>Grand Total: ${currency(totalBarang)}</b>
    `;
    buildRaw(false, waktu, user, {}, barangList, [], totalBarang, 0, 0);
  }

  header.innerHTML=`
    <div class="title">NOTA ${isServis?"SERVIS":"PENJUALAN"}</div>
    <div class="center">${iso(waktu)}</div>
    <div class="center">Nomor: ${tid}</div>`;
  operator.innerHTML=`Operator: ${user}`;

  buildTxt();
}

/* SHARE PNG */
document.getElementById("btnSharePng").onclick = async () => {
  const wrap=document.getElementById("wrap");
  const theCanvas=await html2canvas(wrap,{scale:2});
  const blob=await new Promise(res=>theCanvas.toBlob(res,"image/png"));
  const file=new File([blob],tid+".png",{type:"image/png"});

  if(navigator.canShare && navigator.canShare({files:[file]})){
    await navigator.share({
      title:"Struk "+tid,
      text:"Struk transaksi",
      files:[file]
    });
  }
};

/* COPY TXT */
document.getElementById("btnCopyTxt").onclick=async()=>{try{await navigator.clipboard.writeText(STRUK_TXT);}catch(e){}}

/* DOWNLOAD TXT */
document.getElementById("btnDownloadTxt").onclick=()=>{
  const blob=new Blob([STRUK_TXT],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=tid+".txt";
  a.click();
};

/* PRINT RAW TXT */
document.getElementById("btnPrintTxt").onclick=async()=>{
  const blob=new Blob([RAW_TXT],{type:"text/plain"});
  const file=new File([blob],tid+"_raw.txt",{type:"text/plain"});

  if(navigator.canShare && navigator.canShare({files:[file]})){
    await navigator.share({
      title:"Print Struk",
      text:"File struk untuk printer",
      files:[file]
    });
  }
};

/* TOMBOL TUTORIAL */
btnTutorialTop.onclick=()=>location.href="tutorial.html";

/* CLOSE */
closeBtn.onclick=()=>history.back();

loadStruk();

async function getNamaBarang(id){
  const r=await fetch(`${API_BASE}/api/barang/${id}`);
  const j=await r.json();
  return j.item?.nama || ("Barang #"+id);
}
</script>

</body>
</html>
